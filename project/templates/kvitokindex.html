{% extends 'base.html' %}
{% load static %}

{% block title %}Квитки — Dieller Bus{% endblock %}

{% block head_extra %}
<style>
/* Small overrides for ticket page (uses theme colors) */
.ticket-page{padding:28px 0 60px}
.ticket-title{font-weight:900;margin:0 0 6px;color:#fff}
.ticket-sub{color:var(--muted);margin:0 0 18px}

.search-panel{
  background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.12));
  border:1px solid rgba(255,255,255,0.04);
  border-radius:12px;
  padding:14px;
  margin-bottom:18px;
}

.direction-toggle{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
.dir-btn{border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;border-radius:999px;padding:8px 12px;font-weight:800;cursor:pointer}
.dir-btn.active{background:linear-gradient(90deg,var(--accent-red),var(--accent-red-soft));border-color:transparent}

.search-grid{display:grid;grid-template-columns:1fr 44px 1fr 180px 120px 120px;gap:10px;align-items:end}
@media(max-width:992px){.search-grid{grid-template-columns:1fr 44px 1fr;align-items:stretch}}
@media(max-width:576px){.search-grid{grid-template-columns:1fr}}

.field label{display:block;font-size:12px;font-weight:800;color:var(--muted);margin:0 0 6px}
.field select,.field input{width:100%;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:#0f0f0f;color:#fff;padding:10px 12px;outline:none}
.swap-btn{height:44px;width:44px;border-radius:12px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#fff;font-weight:900;cursor:pointer}
.find-btn{height:46px;border-radius:10px;border:none;font-weight:900;background:linear-gradient(90deg,var(--accent-red),var(--accent-red-soft));color:#fff;padding:0 14px}

.results-head{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;margin:12px 0}
.results-head h2{margin:0;font-weight:900}
.small-muted{color:var(--muted);font-size:13px}

.trip-card{background:#0f0f0f;border:1px solid rgba(225,11,0,0.18);border-radius:12px;padding:12px;margin:12px 0}
.trip-grid{display:grid;grid-template-columns:1.2fr .8fr 1.2fr .6fr .7fr auto;gap:12px;align-items:start}
@media(max-width:992px){.trip-grid{grid-template-columns:1fr 1fr}}
.trip-col .k{color:var(--muted);font-size:12px;font-weight:800;margin-bottom:6px}
.trip-col .v{color:#fff;font-weight:900}
.trip-col .sub{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.35}
.price{color:var(--accent-red-soft);font-weight:900;font-size:18px}
.choose-btn{border:none;background:var(--accent-red);color:#fff;font-weight:900;border-radius:10px;padding:10px 14px;cursor:pointer}
.choose-btn:disabled{opacity:0.45;cursor:not-allowed}

.trip-footer{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.03)}
.badge-soft{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted);font-weight:800;font-size:12px}

/* details panel */
.trip-details{margin-top:12px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.35));border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
.trip-details .grid{display:grid;grid-template-columns:1fr 320px;gap:18px}
.stop-list{display:grid;grid-auto-rows:auto;gap:12px}
.stop-item{display:flex;gap:12px;align-items:flex-start}
.stop-time{font-weight:900;color:var(--accent-red);width:80px}
.stop-info{color:var(--muted);font-size:14px}
.buy-row{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}

.details-right{background:rgba(255,255,255,0.01);padding:12px;border-radius:8px}
.details-right h4{margin:0 0 8px;color:var(--accent-red)}
.details-right p{margin:0;color:var(--muted);font-size:14px}

/* small */
@media(max-width:720px){
  .search-grid{grid-template-columns:1fr}
  .trip-grid{grid-template-columns:1fr}
  .stop-time{width:72px}
  .trip-details .grid{grid-template-columns:1fr}
}
</style>
{% endblock %}

{% block content %}
<section class="ticket-page">
  <div class="container">
    <h1 class="ticket-title">Квитки на автобус</h1>
    <p class="ticket-sub">Знайдіть маршрут, оберіть рейс і купуйте квиток у кілька кліків.</p>

    <div class="search-panel" role="search" aria-label="Пошук рейсу">
      <div class="direction-toggle" role="tablist" aria-label="Напрямок поїздки">
        <button class="dir-btn active" id="dirUA" type="button" aria-pressed="true">Україна → Польща</button>
        <button class="dir-btn" id="dirPL" type="button" aria-pressed="false">Польща → Україна</button>
      </div>

      <div class="search-grid" role="group" aria-label="Параметри пошуку">
        <div class="field">
          <label for="fromCity">Звідки</label>
          <select id="fromCity" aria-label="Звідки"></select>
        </div>

        <button class="swap-btn" id="swapBtn" type="button" title="Поміняти місцями" aria-label="Поміняти місцями">⇄</button>

        <div class="field">
          <label for="toCity">Куди</label>
          <select id="toCity" aria-label="Куди"></select>
        </div>

        <div class="field">
          <label for="travelDate">Дата</label>
          <input id="travelDate" type="date" aria-label="Дата поїздки">
        </div>

        <div class="field">
          <label for="passengers">Пасажири</label>
          <input id="passengers" type="number" min="1" max="6" value="1" aria-label="Кількість пасажирів">
        </div>

        <button class="find-btn" id="findBtn" type="button" aria-label="Знайти рейси">Знайти</button>
      </div>
    </div>

    <div class="results-head">
      <div>
        <h2>Результати</h2>
        <div class="small-muted" id="resultsMeta">Оберіть напрямок та параметри пошуку</div>
      </div>
      <div class="badge-soft" id="resultsBadge" style="display:none;">0 рейсів</div>
    </div>

    <div id="results" aria-live="polite"></div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
(function(){
  // trips: detailed schedule for routes (prices per your list); Любомль/Ягодин use same tariffs as Ковель
  const trips = [
    // PUŁAWY -> LUTSK (detailed)
    {
      id: "PU-LU-0800-DET",
      direction: "PL_UA",
      from: "Пулави",
      from_place: 'Зупинка Стара Автостанція (вул. Войська Польського 7)',
      to: "Луцьк",
      to_place: 'Автовокзал Луцьк, вул. Конякіна, 39',
      depart: "08:00",
      arrive: "16:30",
      duration: "8г 30хв",
      price: 80, currency: "PLN",
      free: 20,
      carrier: "Михалусь П.П",
      stops: [
        {time:"08:00", place:'Пулави, Стара Автостанція (вул. Войська Польського 7)'},
        {time:"08:15", place:'Куров (Biedronka)'},
        {time:"09:00", place:'Люблін, Автовокзал Люблін (старий)'},
        {time:"10:40", place:'Холм, Зупинка "МакДональдс"'},
        {time:"11:05", place:'Ягодин КПП (Україна/Польща), Зупинка "Старовойтове"'},
        {time:"12:50", place:'Добробут, Вишнів'},
        {time:"13:50", place:'Вишнів, Зупинка Вишнів'},
        {time:"15:00", place:'Ковель, Автостанція "Ковель"'},
        {time:"16:30", place:'Луцьк, Автовокзал Луцьк'}
      ]
    },

        // LUBLIN -> LUTSK (detailed)
    {
      id: "LB-LU-0800-DET",
      direction: "PL_UA",
      from: "Люблін",
      from_place: 'Люблін, Автовокзал Люблін (старий автовокзал)',
      to: "Луцьк",
      to_place: 'Автовокзал Луцьк, вул. Конякіна, 39',
      depart: "09:00",
      arrive: "16:30",
      duration: "7г 30хв",
      price: 70, currency: "PLN",
      free: 20,
      carrier: "Михалусь П.П",
      stops: [
        {time:"08:15", place:'Куров (Biedronka)'},
        {time:"09:00", place:'Люблін, Автовокзал Люблін (старий)'},
        {time:"10:40", place:'Холм, Зупинка "МакДональдс"'},
        {time:"11:05", place:'Ягодин КПП (Україна/Польща), Зупинка "Старовойтове"'},
        {time:"12:50", place:'Добробут, Вишнів'},
        {time:"13:50", place:'Вишнів, Зупинка Вишнів'},
        {time:"15:00", place:'Ковель, Автостанція "Ковель"'},
        {time:"16:30", place:'Луцьк, Автовокзал Луцьк'}
      ]
    },

       // LUBLIN -> YAGODYN(detailed)
    {
      id: "LB-LU-0800-DET",
      direction: "PL_UA",
      from: "Люблін",
      from_place: 'Люблін, Автовокзал Люблін (старий автовокзал)',
      to: "Ягодин",
      to_place: 'Ягодин КПП (Україна/Польща), Зупинка "Старовойтове"',
      depart: "09:00",
      arrive: "12:50",
      duration: "3г 50хв",
      price: 50, currency: "PLN",
      free: 20,
      carrier: "Михалусь П.П",
      stops: [
        {time:"09:00", place:'Люблін, Автовокзал Люблін (старий)'},
        {time:"10:40", place:'Холм, Зупинка "МакДональдс"'},
        {time:"11:05", place:'Ягодин КПП (Україна/Польща), Зупинка "Старовойтове"'},
        {time:"12:50", place:'Добробут, Вишнів'},
        {time:"13:50", place:'Вишнів, Зупинка Вишнів'},
      ]
    },

     // LUBLIN -> LUBOML(detailed)
    {
      id: "LB-LU-0800-DET",
      direction: "PL_UA",
      from: "Люблін",
      from_place: 'Люблін, Автовокзал Люблін (старий автовокзал)',
      to: "Любомиль",
      to_place: 'Ягодин КПП (Україна/Польща), Зупинка "Старовойтове"',
      depart: "09:00",
      arrive: "13:50",
      duration: "4г 50хв",
      price: 50, currency: "PLN",
      free: 20,
      carrier: "Михалусь П.П",
      stops: [
        {time:"09:00", place:'Люблін, Автовокзал Люблін (старий)'},
        {time:"10:40", place:'Холм, Зупинка "МакДональдс"'},
        {time:"11:05", place:'Ягодин КПП (Україна/Польща), Зупинка "Старовойтове"'},
        {time:"12:50", place:'Добробут, Вишнів'},
        {time:"13:50", place:'Вишнів, Зупинка Вишнів'},
      ]
    },

    // CHEŁM -> LUTSK (detailed)
    {
      id: "CH-LU-0700-DET",
      direction: "PL_UA",
      from: "Хелм",
      from_place: 'Зупинка "Хелм"',
      to: "Луцьк",
      to_place: 'Автовокзал Луцьк, вул. Конякіна, 39',
      depart: "10:40",
      arrive: "16:30",
      duration: "5г 50хв",
      price: 60, currency: "PLN",
      free: 20,
      carrier: "Михалусь П.П",
      stops: [
        {time:"10:40", place:'Холм, Зупинка "МакДональдс"'},
        {time:"11:05", place:'Ягодин КПП (Україна/Польща), Зупинка "Старовойтове"'},
        {time:"12:50", place:'Добробут, Вишнів'},
        {time:"13:50", place:'Вишнів, Зупинка Вишнів'},
        {time:"15:00", place:'Ковель, Автостанція "Ковель"'},
        {time:"16:30", place:'Луцьк, Автовокзал Луцьк'}
      ]
    },

    


    // LUTSK -> PUŁAWY (detailed)
    {
      id: "LU-PU-1100-DET",
      direction: "UA_PL",
      from: "Луцьк",
      from_place: 'Автовокзал Луцьк, вул. Конякіна, 39',
      to: "Пулави",
      to_place: 'Автостанція Пулави',
      depart: "11:00",
      arrive: "17:30",
      duration: "6г 30хв",
      price: 800, currency: "UAH",
      free: 20,
      carrier: "АВТОСЕРВІС ТУР ТОВ",
      stops: [
        {time:"11:00", place:'Луцьк, Автовокзал'},
        {time:"11:30", place:'Копачівка, Зупинка Копачівка'},
        {time:"12:00", place:'Голоби, Зупинка Голоби'},
        {time:"12:20", place:'Ковель, Автостанція "Ковель"'},
        {time:"12:55", place:'Ковель, Зупинка "АЗС UPG"'},
        {time:"13:10", place:'Луків, Зупинка Луков'},
        {time:"13:30", place:'Любомль, Зупинка Любомль (Вишнів)'},
        {time:"13:50", place:'Ягодин КПП (Україна/Польща), Зупинка "КПП"'},
        {time:"14:20", place:'Холм, Зупинка "МакДональдс"'},
        {time:"15:50", place:'Люблін, Автовокзал Люблін (старий)'},
        {time:"17:30", place:'Пулави, Автостанція Пулави'}
      ]
    },

    // KOVEL -> PULAWY
    {
      id: "KV-PU-0800",
      direction: "UA_PL",
      from: "Ковель",
      from_place: 'Автостанція "Ковель"',
      to: "Пулави",
      to_place: 'Автостанція "Пулави"',
      depart: "12:20",
      arrive: "17:30",
      duration: "4г 0хв",
      price: 700, currency: "UAH",
      free: 15,
      carrier: "Михалусь П.П",
      stops: [
        {time:"12:20", place:'Ковель, Автостанція "Ковель"'},
        {time:"12:55", place:'Ковель, Зупинка "АЗС UPG"'},
        {time:"13:10", place:'Луків, Зупинка Луков'},
        {time:"13:30", place:'Любомль, Зупинка Любомль (Вишнів)'},
        {time:"13:50", place:'Ягодин КПП (Україна/Польща), Зупинка "КПП"'},
        {time:"14:20", place:'Холм, Зупинка "МакДональдс"'},
        {time:"15:50", place:'Люблін, Автовокзал Люблін (старий)'},
        {time:"17:30", place:'Пулави, Автостанція Пулави'}
      ]
    },

    // KOVEL -> LUBLIN
    {
      id: "KV-LB-0830",
      direction: "UA_PL",
      from: "Ковель",
      from_place: 'Автостанція "Ковель"',
      to: "Люблін",
      to_place: 'Автостанція "Люблін"',
      depart: "12:20",
      arrive: "15:50",
      duration: "3г 30хв",
      price: 500, currency: "UAH",
      free: 14,
      carrier: "Михалусь П.П",
      stops: [
        {time:"12:20", place:'Ковель, Автостанція "Ковель"'},
        {time:"12:55", place:'Ковель, Зупинка "АЗС UPG"'},
        {time:"13:10", place:'Луків, Зупинка Луков'},
        {time:"13:30", place:'Любомль, Зупинка Любомль (Вишнів)'},
        {time:"13:50", place:'Ягодин КПП (Україна/Польща), Зупинка "КПП"'},
        {time:"14:20", place:'Холм, Зупинка "МакДональдс"'},
        {time:"15:50", place:'Люблін, Автовокзал Люблін (старий)'},
      ]
    },

    // KOVEL -> CHEŁM
    {
      id: "KV-CH-0700",
      direction: "UA_PL",
      from: "Ковель",
      from_place: 'Автостанція "Ковель"',
      to: "Хелм",
      to_place: 'Зупинка "Хелм"',
      depart: "12:20",
      arrive: "14:20",
      duration: "2г 0хв",
      price: 400, currency: "UAH",
      free: 12,
      carrier: "Михалусь П.П",
      stops: [
        {time:"12:20", place:'Ковель, Автостанція "Ковель"'},
        {time:"12:55", place:'Ковель, Зупинка "АЗС UPG"'},
        {time:"13:10", place:'Луків, Зупинка Луков'},
        {time:"13:30", place:'Любомль, Зупинка Любомль (Вишнів)'},
        {time:"13:50", place:'Ягодин КПП (Україна/Польща), Зупинка "КПП"'},
        {time:"14:20", place:'Холм, Зупинка "МакДональдс"'},
      ]
    },

    // YAGODYN -> PULAWY (same prices as Kovel)
    {
      id: "YG-PU-0900",
      direction: "UA_PL",
      from: "Ягодин",
      from_place: 'КПП "Ягодин"',
      to: "Пулави",
      to_place: 'Автостанція "Пулави"',
      depart: "13:50",
      arrive: "17:30",
      duration: "3г 40хв",
      price: 700, currency: "UAH",
      free: 10,
      carrier: "Михалусь П.П",
      stops: [
        {time:"13:10", place:'Луків, Зупинка Луков'},
        {time:"13:30", place:'Любомль, Зупинка Любомль (Вишнів)'},
        {time:"13:50", place:'Ягодин КПП (Україна/Польща), Зупинка "КПП"'},
        {time:"14:20", place:'Холм, Зупинка "МакДональдс"'},
        {time:"15:50", place:'Люблін, Автовокзал Люблін (старий)'},
        {time:"17:30", place:'Пулави, Автостанція Пулави'}
      ]
    },

    // YAGODYN -> LUBLIN
    {
      id: "YG-LB-0915",
      direction: "UA_PL",
      from: "Ягодин",
      from_place: 'КПП "Ягодин"',
      to: "Люблін",
      to_place: 'Автостанція "Люблін"',
      depart: "13:50",
      arrive: "15:50",
      duration: "2г 00хв",
      price: 500, currency: "UAH",
      free: 12,
      carrier: "Михалусь П.П",
      stops: [
        {time:"13:10", place:'Луків, Зупинка Луков'},
        {time:"13:30", place:'Любомль, Зупинка Любомль (Вишнів)'},
        {time:"13:50", place:'Ягодин КПП (Україна/Польща), Зупинка "КПП"'},
        {time:"14:20", place:'Холм, Зупинка "МакДональдс"'},
        {time:"15:50", place:'Люблін, Автовокзал Люблін (старий)'},
      ]
    },

    // YAGODYN -> CHEŁM
    {
      id: "YG-CH-0830",
      direction: "UA_PL",
      from: "Ягодин",
      from_place: 'КПП "Ягодин"',
      to: "Хелм",
      to_place: 'Зупинка "Хелм"',
      depart: "08:30",
      arrive: "10:00",
      duration: "1г 30хв",
      price: 400, currency: "UAH",
      free: 10,
      carrier: "Михалусь П.П",
      stops: [
        {time:"13:30", place:'Любомль, Зупинка Любомль (Вишнів)'},
        {time:"13:50", place:'Ягодин КПП (Україна/Польща), Зупинка "КПП"'},
        {time:"14:20", place:'Холм, Зупинка "МакДональдс"'},
      ]
    },

    // LUBOML -> PULAWY (same as Kovel prices)
    {
      id: "LBM-PU-0930",
      direction: "UA_PL",
      from: "Любомль",
      from_place: 'Зупинка "Любомль"',
      to: "Пулави",
      to_place: 'Автостанція "Пулави"',
      depart: "13:30",
      arrive: "17:00",
      duration: "3г 30хв",
      price: 700, currency: "UAH",
      free: 12,
      carrier: "Михалусь П.П",
      stops: [
        {time:"13:30", place:'Любомль, Зупинка Любомль (Вишнів)'},
        {time:"13:50", place:'Ягодин КПП (Україна/Польща), Зупинка "КПП"'},
        {time:"14:20", place:'Холм, Зупинка "МакДональдс"'},
        {time:"15:50", place:'Люблін, Автовокзал Люблін (старий)'},
        {time:"17:30", place:'Пулави, Автостанція Пулави'}
      ]
    },

    // LUBOML -> LUBLIN
    {
      id: "LBM-LB-1000",
      direction: "UA_PL",
      from: "Любомль",
      from_place: 'Зупинка "Любомль"',
      to: "Люблін",
      to_place: 'Автостанція "Люблін"',
      depart: "13:30",
      arrive: "15:50",
      duration: "2г 20хв",
      price: 500, currency: "UAH",
      free: 12,
      carrier: "Михалусь П.П",
      stops: [
        {time:"13:30", place:'Любомль, Зупинка Любомль (Вишнів)'},
        {time:"13:50", place:'Ягодин КПП (Україна/Польща), Зупинка "КПП"'},
        {time:"14:20", place:'Холм, Зупинка "МакДональдс"'},
        {time:"15:50", place:'Люблін, Автовокзал Люблін (старий)'},
      ]
    },

    // LUBOML -> CHEŁM
    {
      id: "LBM-CH-0830",
      direction: "UA_PL",
      from: "Любомль",
      from_place: 'Зупинка "Любомль"',
      to: "Хелм",
      to_place: 'Зупинка "Хелм"',
      depart: "13:30",
      arrive: "14:20",
      duration: "0г 50хв",
      price: 400, currency: "UAH",
      free: 10,
      carrier: "Михалусь П.П",
      stops: [
        {time:"13:30", place:'Любомль, Зупинка Любомль (Вишнів)'},
        {time:"13:50", place:'Ягодин КПП (Україна/Польща), Зупинка "КПП"'},
        {time:"14:20", place:'Холм, Зупинка "МакДональдс"'},
      ]
    },

    // PL -> UA simplified (PLN prices, match Kovel equivalents)
    { id: "PU-KV-0830", direction: "PL_UA", from: "Пулави", from_place: 'Автостанція "Пулави"', to: "Ковель", to_place: 'Автостанція "Ковель"', depart: "08:30", arrive: "11:00", duration: "2г 30хв", price: 70, currency: "PLN", free: 12, carrier: "Михалусь П.П", stops:[{time:"08:30",place:"Пулави"},{time:"10:00",place:"Люблін"},{time:"11:00",place:"Ковель"}] },
    { id: "LB-KV-1000", direction: "PL_UA", from: "Люблін", from_place: 'Автостанція "Люблін"', to: "Ковель", to_place: 'Автостанція "Ковель"', depart: "10:00", arrive: "12:30", duration: "2г 30хв", price: 60, currency: "PLN", free: 10, carrier: "Михалусь П.П", stops:[{time:"10:00",place:"Люблін"},{time:"11:20",place:"Ягодин КПП"},{time:"12:30",place:"Ковель"}] },
    { id: "CH-KV-0730", direction: "PL_UA", from: "Хелм", from_place: 'Зупинка "Хелм"', to: "Ковель", to_place: 'Автостанція "Ковель"', depart: "07:30", arrive: "10:00", duration: "2г 30хв", price: 50, currency: "PLN", free: 8, carrier: "Михалусь П.П", stops:[{time:"07:30",place:"Хелм"},{time:"09:00",place:"Ягодин КПП"},{time:"10:00",place:"Ковель"}] },

    // PL -> Любомль / Ягодин equivalents (PLN)
    { id: "PU-LBM-0830", direction: "PL_UA", from: "Пулави", from_place: 'Автостанція "Пулави"', to: "Любомль", to_place: 'Зупинка "Любомль"', depart: "08:30", arrive: "12:30", duration: "4г 0хв", price: 70, currency: "PLN", free: 8, carrier: "Михалусь П.П", stops:[{time:"08:30",place:"Пулави"},{time:"10:40",place:"Люблін"},{time:"12:30",place:"Любомль"}] },
    { id: "PU-YG-0830", direction: "PL_UA", from: "Пулави", from_place: 'Автостанція "Пулави"', to: "Ягодин", to_place: 'КПП "Ягодин"', depart: "08:30", arrive: "11:10", duration: "2г 40хв", price: 70, currency: "PLN", free: 8, carrier: "Михалусь П.П", stops:[{time:"08:30",place:"Пулави"},{time:"10:00",place:"Люблін"},{time:"11:10",place:"Ягодин КПП"}] }
  ];

  // helper to format price with correct currency label
  function formatPrice(price, currency){
    if (!currency || currency === 'UAH') return `${Number(price).toFixed(0)} грн`;
    if (currency === 'PLN') return `${Number(price).toFixed(0)} zł`;
    return `${Number(price).toFixed(2)} ${currency}`;
  }

  // elements & city lists
  const UA_CITIES = ["Луцьк","Ковель","Ягодин","Любомль"];
  const PL_CITIES = ["Пулави","Люблін","Хелм"];

  const dirUA = document.getElementById('dirUA');
  const dirPL = document.getElementById('dirPL');
  const swapBtn = document.getElementById('swapBtn');
  const fromCity = document.getElementById('fromCity');
  const toCity = document.getElementById('toCity');
  const travelDate = document.getElementById('travelDate');
  const passengers = document.getElementById('passengers');
  const findBtn = document.getElementById('findBtn');
  const results = document.getElementById('results');
  const resultsMeta = document.getElementById('resultsMeta');
  const resultsBadge = document.getElementById('resultsBadge');

  let currentDirection = "UA_PL";

  function setDirection(dir){
    currentDirection = dir;
    dirUA.classList.toggle('active', dir === 'UA_PL');
    dirPL.classList.toggle('active', dir === 'PL_UA');
    dirUA.setAttribute('aria-pressed', dir === 'UA_PL');
    dirPL.setAttribute('aria-pressed', dir === 'PL_UA');

    const fromList = (dir === "UA_PL") ? UA_CITIES : PL_CITIES;
    const toList = (dir === "UA_PL") ? PL_CITIES : UA_CITIES;
    fillSelect(fromCity, fromList);
    fillSelect(toCity, toList);
    fromCity.value = fromList[0] || "";
    toCity.value = toList[0] || "";
    results.innerHTML = "";
    resultsMeta.textContent = "Натисніть “Знайти”, щоб показати доступні рейси.";
    resultsBadge.style.display = "none";
  }

  function fillSelect(select, list){
    select.innerHTML = '';
    list.forEach(c => {
      const o = document.createElement('option'); o.value = c; o.textContent = c;
      select.appendChild(o);
    });
  }

  function fmtDate(d){
    if (!d) return "";
    try{ const [y,m,dd] = d.split('-'); return `${dd}.${m}.${y}` }catch(e){return d}
  }

  function renderTripCard(t, pax){
    const total = t.price * pax;
    const disabled = (t.free < pax);

    return `
      <div class="trip-card" data-id="${t.id}">
        <div class="trip-grid">
          <div class="trip-col">
            <div class="k">Відправлення</div>
            <div class="v">${t.depart}</div>
            <div class="sub">${t.from}, ${t.from_place}</div>
          </div>

          <div class="trip-col">
            <div class="k">В дорозі</div>
            <div class="v">${t.duration}</div>
            <div class="sub">${t.carrier}</div>
          </div>

          <div class="trip-col">
            <div class="k">Прибуття</div>
            <div class="v">${t.arrive}</div>
            <div class="sub">${t.to}, ${t.to_place}</div>
          </div>

          <div class="trip-col">
            <div class="k">Вільних місць</div>
            <div class="v seats-count">${t.free}</div>
          </div>

          <div class="trip-col">
            <div class="k">Ціна</div>
            <div class="price">${formatPrice(t.price, t.currency)}</div>
            <div class="sub">Разом: <strong style="color:#fff">${formatPrice(total, t.currency)}</strong></div>
          </div>

          <div class="trip-col" style="display:flex;justify-content:flex-end;align-items:center">
            <button class="choose-btn" type="button" ${disabled ? "disabled" : ""}>Обрати</button>
          </div>
        </div>

        <div class="trip-footer">
          <span class="badge-soft">Маршрут: <strong style="color:#fff">${t.from} → ${t.to}</strong></span>
          <span class="badge-soft">Пасажири: <strong style="color:#fff">${pax}</strong></span>
          <button class="btn-secondary details-toggle" type="button" style="margin-left:8px">Деталі</button>
        </div>

        <div class="trip-details" style="display:none" aria-hidden="true">
          <div class="grid">
            <div>
              <h4>Рейс: ${t.from} - ${t.to}</h4>
              <div class="stop-list">
                ${t.stops.map(s => `<div class="stop-item"><div class="stop-time">${s.time}</div><div class="stop-info">${s.place}</div></div>`).join('')}
              </div>
            </div>

            <div class="details-right" aria-label="Деталі рейсу">
              <h4>Інформація</h4>
              <p><strong>Перевізник:</strong> ${t.carrier}</p>
              <p><strong>Відправлення:</strong> ${t.depart}</p>
              <p><strong>Прибуття:</strong> ${t.arrive}</p>
              <p><strong>Дата поїздки:</strong> <span class="selected-date">${fmtDate(travelDate.value)}</span></p>
              <p><strong>Вільних місць:</strong> <span class="seats-count-right">${t.free}</span></p>
              <div class="buy-row">
                <button class="choose-btn buy-now" ${disabled ? "disabled" : ""}>Купити</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function doSearch(){
    const f = fromCity.value;
    const t = toCity.value;
    const d = travelDate.value;
    const pax = Math.max(1, Math.min(6, parseInt(passengers.value || "1", 10)));

    if (!f || !t || f === t){
      results.innerHTML = "";
      resultsMeta.textContent = "Оберіть різні пункти відправлення та призначення.";
      resultsBadge.style.display = "none";
      return;
    }

    const list = trips.filter(x => x.direction === currentDirection && x.from === f && x.to === t);

    resultsMeta.textContent = `${f} — ${t}${d ? " на " + fmtDate(d) : ""}`;
    resultsBadge.style.display = "inline-flex";
    resultsBadge.textContent = `${list.length} рейс(ів)`;

    if (!list.length){
      results.innerHTML = `<div class="small-muted">Немає рейсів за цими параметрами. Спробуйте іншу дату або напрямок.</div>`;
      return;
    }

    results.innerHTML = list.map(x => renderTripCard(x, pax)).join("");

    // attach handlers
    results.querySelectorAll('.trip-card').forEach(card => {
      const id = card.dataset.id;
      const chooseBtn = card.querySelector('.choose-btn');
      const buyNow = card.querySelector('.buy-now');
      const detailsToggle = card.querySelector('.details-toggle');
      const detailsPanel = card.querySelector('.trip-details');

      detailsToggle.addEventListener('click', () => {
        const opened = detailsPanel.style.display !== 'none';
        document.querySelectorAll('.trip-details').forEach(p => { if (p !== detailsPanel) { p.style.display = 'none'; p.setAttribute('aria-hidden','true'); }});
        detailsPanel.style.display = opened ? 'none' : 'block';
        detailsPanel.setAttribute('aria-hidden', opened ? 'true' : 'false');
        detailsToggle.textContent = opened ? 'Деталі' : 'Згорнути';
        const dateSpan = detailsPanel.querySelector('.selected-date');
        if (dateSpan) dateSpan.textContent = (travelDate.value ? (function(){const [yy,mm,dd]=travelDate.value.split('-');return dd+'.'+mm+'.'+yy;})() : '');
      });

      chooseBtn.addEventListener('click', () => {
        document.querySelectorAll('.trip-details').forEach(p => { p.style.display = 'none'; p.setAttribute('aria-hidden','true'); });
        detailsPanel.style.display = 'block';
        detailsPanel.setAttribute('aria-hidden', 'false');
        detailsToggle.textContent = 'Згорнути';
        detailsPanel.scrollIntoView({behavior:'smooth', block:'center'});
        const dateSpan = detailsPanel.querySelector('.selected-date');
        if (dateSpan) dateSpan.textContent = (travelDate.value ? (function(){const [yy,mm,dd]=travelDate.value.split('-');return dd+'.'+mm+'.'+yy;})() : '');
      });

      buyNow.addEventListener('click', () => {
        const pax = Math.max(1, Math.min(6, parseInt(passengers.value || "1", 10)));
        const trip = trips.find(x => x.id === id);
        if (!trip) return;
        if (trip.free < pax){
          alert("Недостатньо вільних місць для цієї кількості пасажирів.");
          return;
        }
        trip.free -= pax;
        const seatEl = card.querySelector('.seats-count');
        const seatElRight = card.querySelector('.seats-count-right');
        if (seatEl) seatEl.textContent = trip.free;
        if (seatElRight) seatElRight.textContent = trip.free;
        if (trip.free <= 0){
          card.querySelectorAll('.choose-btn, .buy-now').forEach(b => b.disabled = true);
        }
        alert(`Бронь створена (фронтенд). Сума: ${ formatPrice(trip.price * pax, trip.currency) }.`);
      });
    });
  }

  // events
  dirUA.addEventListener('click', () => setDirection('UA_PL'));
  dirPL.addEventListener('click', () => setDirection('PL_UA'));
  swapBtn.addEventListener('click', () => { setDirection(currentDirection === "UA_PL" ? "PL_UA" : "UA_PL"); });
  findBtn.addEventListener('click', doSearch);

  // init
  setDirection('UA_PL');
  const now = new Date(); const y = now.getFullYear(); const m = String(now.getMonth()+1).padStart(2,'0'); const d = String(now.getDate()).padStart(2,'0');
  travelDate.value = `${y}-${m}-${d}`;
})();
</script>
{% endblock %}
